<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemical Formula Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .intro-screen, .game-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .intro-screen {
            text-align: center;
        }

        .intro-screen h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .intro-screen .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 40px;
        }

        .level-selection {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        .level-card {
            background: #f8f9fa;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .level-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .level-card h2 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .level-card .difficulty {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .difficulty.easy {
            background: #d4edda;
            color: #155724;
        }

        .difficulty.hard {
            background: #f8d7da;
            color: #721c24;
        }

        .level-card p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .level-card .features {
            margin-top: 15px;
            padding-left: 20px;
        }

        .level-card .features li {
            color: #666;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .intro-screen, .game-container {
                padding: 20px;
                border-radius: 15px;
            }

            .intro-screen h1 {
                font-size: 1.8em;
            }

            .level-card {
                padding: 20px;
            }

            .level-card h2 {
                font-size: 1.2em;
            }
        }

        .game-container {
            display: none;
        }

        .game-container.active {
            display: block;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
                border-radius: 15px;
            }
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .level-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .stats {
                padding: 15px 10px;
                margin-bottom: 20px;
            }
        }

        .stat {
            text-align: center;
            min-width: 80px;
        }

        .stat-label {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .stat-value {
                font-size: 1.4em;
            }
        }

        .timer-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .timer {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .timer.warning {
            color: #e74c3c;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @media (max-width: 768px) {
            .timer {
                font-size: 2em;
            }
        }

        .question-box {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .question-box {
                padding: 20px 15px;
            }
        }

        .ions-display {
            font-size: 1.1em;
            margin-bottom: 20px;
            line-height: 1.8;
        }

        @media (max-width: 768px) {
            .ions-display {
                font-size: 1em;
            }
        }

        .ion {
            display: inline-block;
            margin: 10px 15px;
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .ion {
                margin: 5px 10px;
                padding: 10px 15px;
                font-size: 0.9em;
            }
        }

        .cation {
            color: #e74c3c;
        }

        .anion {
            color: #3498db;
        }

        .compound-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .compound-name {
                font-size: 1.1em;
            }
        }

        .hint-box {
            background: #e7f3ff;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .hint-box .hint-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .hint-box .hint-content {
            color: #666;
            line-height: 1.6;
        }

        .input-section {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .input-label {
                font-size: 1em;
            }
        }

        #formulaInput {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            border: 3px solid #ddd;
            border-radius: 10px;
            text-align: center;
            font-family: monospace;
            transition: border-color 0.3s;
        }

        @media (max-width: 768px) {
            #formulaInput {
                font-size: 1.1em;
                padding: 12px;
            }
        }

        #formulaInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .hint {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 8px;
            font-size: 0.9em;
            color: #856404;
        }

        @media (max-width: 768px) {
            .hint {
                font-size: 0.8em;
                padding: 8px;
            }
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        @media (max-width: 768px) {
            button {
                padding: 12px;
                font-size: 1em;
                min-width: 100px;
            }
        }

        .submit-btn {
            background: #667eea;
            color: white;
        }

        .submit-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .skip-btn {
            background: #95a5a6;
            color: white;
        }

        .skip-btn:hover {
            background: #7f8c8d;
        }

        .back-btn {
            background: #e74c3c;
            color: white;
            width: 100%;
        }

        .back-btn:hover {
            background: #c0392b;
        }

        .new-game-btn {
            background: #2ecc71;
            color: white;
            width: 100%;
        }

        .new-game-btn:hover {
            background: #27ae60;
        }

        .sound-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s;
        }

        .sound-toggle:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .sound-toggle {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
                top: 15px;
                right: 15px;
            }
        }

        .feedback {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .feedback {
                padding: 15px;
                font-size: 1em;
            }
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .feedback.hidden {
            display: none;
        }

        .explanation {
            margin-top: 10px;
            font-size: 0.95em;
            font-weight: normal;
            text-align: left;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .explanation {
                font-size: 0.85em;
            }
        }

        .subscript {
            font-size: 0.7em;
            vertical-align: sub;
        }

        .superscript {
            font-size: 0.7em;
            vertical-align: super;
        }
    </style>
</head>
<body>
    <!-- Intro Screen -->
    <div class="intro-screen" id="introScreen">
        <h1>‚öóÔ∏è Chemical Formula Challenge</h1>
        <p class="subtitle">N Level Cambridge Chemistry Practice</p>
        
        <p style="color: #666; margin: 20px 0; font-size: 1.1em;">Choose your difficulty level:</p>
        
        <div class="level-selection">
            <div class="level-card" onclick="startGame(1)">
                <h2>üü¢ Level 1: With Charges</h2>
                <span class="difficulty easy">EASIER</span>
                <p>See the ions with their charges displayed. Perfect for learning the basics!</p>
                <ul class="features">
                    <li>‚úì Ion charges shown (e.g., Na‚Å∫, Cl‚Åª)</li>
                    <li>‚úì 20 seconds per question</li>
                    <li>‚úì Practice charge balancing</li>
                </ul>
            </div>
            
            <div class="level-card" onclick="startGame(2)">
                <h2>üî¥ Level 2: Names Only</h2>
                <span class="difficulty hard">HARDER</span>
                <p>Only the compound name is shown. You must remember the ion charges!</p>
                <ul class="features">
                    <li>‚úì No charges displayed</li>
                    <li>‚úì 30 seconds per question</li>
                    <li>‚úì Hint at 15 seconds (periodic table groups)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div class="game-container" id="gameContainer">
        <button class="sound-toggle" id="soundToggle" title="Toggle Sound">üîä</button>
        
        <h1>‚öóÔ∏è Chemical Formula Challenge</h1>
        <div class="level-info" id="levelInfo">Level 1: With Charges</div>

        <div class="stats">
            <div class="stat">
                <div class="stat-label">Score</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Streak</div>
                <div class="stat-value" id="streak">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Total</div>
                <div class="stat-value" id="total">0</div>
            </div>
        </div>

        <div class="timer-container">
            <div class="timer" id="timer">20</div>
        </div>

        <div id="hintContainer"></div>

        <div class="question-box">
            <div class="ions-display" id="ionsDisplay"></div>
        </div>

        <div class="feedback hidden" id="feedback"></div>

        <div class="input-section">
            <label class="input-label" for="formulaInput">Enter the chemical formula:</label>
            <input type="text" id="formulaInput" placeholder="e.g., MgCl‚ÇÇ" autocomplete="off">
            <div class="hint">üí° Use numbers for subscripts (e.g., H2O, Ca3PO4). Use brackets for polyatomic ions with subscript > 1 (e.g., Mg(NO3)2)</div>
        </div>

        <div class="button-group">
            <button class="submit-btn" id="submitBtn">Check Answer</button>
            <button class="skip-btn" id="skipBtn">Skip</button>
        </div>

        <button class="back-btn" onclick="backToMenu()">Back to Menu</button>
    </div>

    <script>
        // Ion data for N level Cambridge
        const cations = [
            { name: 'sodium', symbol: 'Na', charge: 1, group: 1 },
            { name: 'potassium', symbol: 'K', charge: 1, group: 1 },
            { name: 'silver', symbol: 'Ag', charge: 1, group: 11 },
            { name: 'lithium', symbol: 'Li', charge: 1, group: 1 },
            { name: 'magnesium', symbol: 'Mg', charge: 2, group: 2 },
            { name: 'calcium', symbol: 'Ca', charge: 2, group: 2 },
            { name: 'barium', symbol: 'Ba', charge: 2, group: 2 },
            { name: 'zinc', symbol: 'Zn', charge: 2, group: 12 },
            { name: 'copper(II)', symbol: 'Cu', charge: 2, group: 11 },
            { name: 'iron(II)', symbol: 'Fe', charge: 2, group: 8 },
            { name: 'lead(II)', symbol: 'Pb', charge: 2, group: 14 },
            { name: 'aluminium', symbol: 'Al', charge: 3, group: 13 },
            { name: 'iron(III)', symbol: 'Fe', charge: 3, group: 8 },
            { name: 'ammonium', symbol: 'NH4', charge: 1, group: null }
        ];

        const anions = [
            { name: 'chloride', symbol: 'Cl', charge: 1, group: 17 },
            { name: 'bromide', symbol: 'Br', charge: 1, group: 17 },
            { name: 'iodide', symbol: 'I', charge: 1, group: 17 },
            { name: 'fluoride', symbol: 'F', charge: 1, group: 17 },
            { name: 'hydroxide', symbol: 'OH', charge: 1, group: null },
            { name: 'nitrate', symbol: 'NO3', charge: 1, group: null },
            { name: 'oxide', symbol: 'O', charge: 2, group: 16 },
            { name: 'sulfide', symbol: 'S', charge: 2, group: 16 },
            { name: 'sulfate', symbol: 'SO4', charge: 2, group: null },
            { name: 'carbonate', symbol: 'CO3', charge: 2, group: null },
            { name: 'phosphate', symbol: 'PO4', charge: 3, group: null },
            { name: 'nitride', symbol: 'N', charge: 3, group: 15 }
        ];

        let currentCation, currentAnion, correctFormula;
        let score = 0, streak = 0, total = 0;
        let wrongAnswers = []; // Queue to store wrong answers for repetition
        const MAX_WRONG_QUEUE = 3; // Maximum number of wrong answers to keep in queue
        let currentLevel = 1; // 1 = with charges, 2 = names only
        let timerInterval;
        let timeRemaining = 30;
        let soundEnabled = true;

        // Sound effects using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (!soundEnabled) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'correct') {
                // Pleasant ascending chime
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            } else if (type === 'incorrect') {
                // Gentle descending tone
                oscillator.frequency.setValueAtTime(392, audioContext.currentTime); // G4
                oscillator.frequency.setValueAtTime(349.23, audioContext.currentTime + 0.15); // F4
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'tick') {
                // Subtle tick sound
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.05);
            } else if (type === 'warning') {
                // Warning beep
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } else if (type === 'victory') {
                // Victory fanfare
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                notes.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                    gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.15);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.15 + 0.3);
                    osc.start(audioContext.currentTime + i * 0.15);
                    osc.stop(audioContext.currentTime + i * 0.15 + 0.3);
                });
            }
        }

        function startTimer() {
            // Level 1: 20 seconds, Level 2: 30 seconds
            timeRemaining = currentLevel === 1 ? 20 : 30;
            updateTimerDisplay();
            
            // Clear hint if it exists
            document.getElementById('hintContainer').innerHTML = '';
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                // Show hint at 15 seconds for Level 2
                if (currentLevel === 2 && timeRemaining === 15) {
                    showHint();
                }
                
                if (timeRemaining <= 5 && timeRemaining > 0) {
                    playSound('warning');
                }
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        function showHint() {
            const hintContainer = document.getElementById('hintContainer');
            let hintHTML = '<div class="hint-box"><div class="hint-title">üí° Periodic Table Hint</div><div class="hint-content">';
            
            // Show group information for single-element ions
            if (currentCation.group !== null) {
                hintHTML += `${currentCation.symbol} is in Group ${currentCation.group}<br>`;
            } else {
                hintHTML += `${currentCation.symbol} is a polyatomic ion with charge ${currentCation.charge}+<br>`;
            }
            
            if (currentAnion.group !== null) {
                hintHTML += `${currentAnion.symbol} is in Group ${currentAnion.group}`;
            } else {
                hintHTML += `${currentAnion.symbol} is a polyatomic ion with charge ${currentAnion.charge}‚àí`;
            }
            
            hintHTML += '</div></div>';
            hintContainer.innerHTML = hintHTML;
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('timer');
            timerEl.textContent = timeRemaining;
            
            if (timeRemaining <= 5) {
                timerEl.classList.add('warning');
            } else {
                timerEl.classList.remove('warning');
            }
        }

        function handleTimeout() {
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback incorrect';
            feedback.innerHTML = `‚è∞ Time's up! The correct formula is ${toSubscript(correctFormula)}`;
            
            total++;
            streak = 0;
            addToWrongAnswers(currentCation, currentAnion);
            updateStats();
            
            setTimeout(() => {
                newQuestion();
            }, 3000);
        }

        function addToWrongAnswers(cation, anion) {
            // Check if this combination already exists in the queue
            const exists = wrongAnswers.some(q => 
                q.cation.symbol === cation.symbol && q.anion.symbol === anion.symbol
            );
            
            if (!exists) {
                wrongAnswers.push({ cation, anion, attempts: 0 });
                // Keep only the most recent wrong answers
                if (wrongAnswers.length > MAX_WRONG_QUEUE) {
                    wrongAnswers.shift(); // Remove oldest
                }
            }
        }

        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function gcd(a, b) {
            return b === 0 ? a : gcd(b, a % b);
        }

        function isPolyatomic(symbol) {
            // Polyatomic ions contain more than one element (more than one capital letter or contains lowercase)
            const capitals = symbol.match(/[A-Z]/g);
            return capitals && capitals.length > 1;
        }

        function generateFormula(cation, anion) {
            const divisor = gcd(cation.charge, anion.charge);
            const cationCount = anion.charge / divisor;
            const anionCount = cation.charge / divisor;

            let formula = '';
            
            // Handle cation
            if (isPolyatomic(cation.symbol) && cationCount > 1) {
                formula += '(' + cation.symbol + ')' + cationCount;
            } else {
                formula += cation.symbol;
                if (cationCount > 1) formula += cationCount;
            }

            // Handle anion
            // Add parentheses for polyatomic ions if count > 1
            if (isPolyatomic(anion.symbol) && anionCount > 1) {
                formula += '(' + anion.symbol + ')' + anionCount;
            } else {
                formula += anion.symbol;
                if (anionCount > 1) formula += anionCount;
            }

            return formula;
        }

        function formatIonDisplay(symbol, charge) {
            const chargeStr = charge > 1 ? charge + '+' : (charge < -1 ? Math.abs(charge) + '‚àí' : (charge === 1 ? '+' : '‚àí'));
            return `${symbol}<span class="superscript">${chargeStr}</span>`;
        }

        function toSubscript(str) {
            const subscriptMap = { '0': '‚ÇÄ', '1': '‚ÇÅ', '2': '‚ÇÇ', '3': '‚ÇÉ', '4': '‚ÇÑ', '5': '‚ÇÖ', '6': '‚ÇÜ', '7': '‚Çá', '8': '‚Çà', '9': '‚Çâ' };
            return str.replace(/\d/g, digit => subscriptMap[digit] || digit);
        }

        function normalizeFormula(formula) {
            // Convert subscript numbers to regular numbers
            let normalized = formula.replace(/[‚ÇÄ‚ÇÅ‚ÇÇ‚ÇÉ‚ÇÑ‚ÇÖ‚ÇÜ‚Çá‚Çà‚Çâ]/g, char => {
                return '0123456789'['‚ÇÄ‚ÇÅ‚ÇÇ‚ÇÉ‚ÇÑ‚ÇÖ‚ÇÜ‚Çá‚Çà‚Çâ'.indexOf(char)];
            }).replace(/\s/g, '');
            
            return normalized;
        }

        function checkBrackets(userFormula, correctFormula) {
            // Check if brackets are needed and correctly placed
            const userHasBrackets = userFormula.includes('(') && userFormula.includes(')');
            const correctHasBrackets = correctFormula.includes('(') && correctFormula.includes(')');
            
            return userHasBrackets === correctHasBrackets;
        }

        function newQuestion() {
            // 60% chance to repeat a wrong answer if available, after the first question
            const shouldRepeatWrong = wrongAnswers.length > 0 && total > 0 && Math.random() < 0.6;
            
            if (shouldRepeatWrong) {
                // Get a wrong answer from the queue
                const wrongQuestion = wrongAnswers[Math.floor(Math.random() * wrongAnswers.length)];
                currentCation = wrongQuestion.cation;
                currentAnion = wrongQuestion.anion;
                wrongQuestion.attempts++;
            } else {
                // Generate a new random question
                currentCation = getRandomElement(cations);
                currentAnion = getRandomElement(anions);
            }
            
            correctFormula = generateFormula(currentCation, currentAnion);

            const ionsDisplay = document.getElementById('ionsDisplay');
            
            if (currentLevel === 1) {
                // Level 1: Show charges
                ionsDisplay.innerHTML = `
                    <div>
                        <span class="ion cation">${formatIonDisplay(currentCation.symbol, currentCation.charge)}</span>
                        <span style="font-size: 1.5em;">+</span>
                        <span class="ion anion">${formatIonDisplay(currentAnion.symbol, -currentAnion.charge)}</span>
                    </div>
                    <div class="compound-name">${currentCation.name} ${currentAnion.name}</div>
                `;
            } else {
                // Level 2: Show only compound name (no duplicate)
                ionsDisplay.innerHTML = `
                    <div class="compound-name" style="font-size: 1.5em; color: #667eea; margin: 20px 0;">
                        ${currentCation.name} ${currentAnion.name}
                    </div>
                `;
            }
            
            document.getElementById('formulaInput').value = '';
            
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback hidden';
            feedback.innerHTML = '';
            
            document.getElementById('formulaInput').focus();
            
            // Start the timer
            startTimer();
        }

        function checkAnswer() {
            clearInterval(timerInterval); // Stop the timer
            
            const userAnswer = normalizeFormula(document.getElementById('formulaInput').value);
            const normalized = normalizeFormula(correctFormula);
            const feedback = document.getElementById('feedback');

            total++;

            if (userAnswer === normalized) {
                score++;
                streak++;
                feedback.className = 'feedback correct';
                feedback.innerHTML = `‚úì Correct! The formula is ${toSubscript(correctFormula)}`;
                
                playSound('correct');
                
                // Remove from wrong answers queue if it was there
                wrongAnswers = wrongAnswers.filter(q => 
                    q.cation.symbol !== currentCation.symbol || q.anion.symbol !== currentAnion.symbol
                );
                
                if (streak === 5) {
                    setTimeout(() => {
                        playSound('victory');
                        showGameOver();
                    }, 2000);
                } else {
                    setTimeout(() => {
                        newQuestion();
                    }, 2000);
                }
            } else {
                streak = 0;
                feedback.className = 'feedback incorrect';
                
                playSound('incorrect');
                
                let explanation = getDetailedExplanation(userAnswer, normalized);
                
                feedback.innerHTML = `‚úó Incorrect. ${explanation}`;
                
                // Add to wrong answers queue for repetition
                addToWrongAnswers(currentCation, currentAnion);
                
                setTimeout(() => {
                    newQuestion();
                }, 20000);
            }

            updateStats();
        }

        function getDetailedExplanation(userAnswer, correctAnswer) {
            const divisor = gcd(currentCation.charge, currentAnion.charge);
            const cationCount = currentAnion.charge / divisor;
            const anionCount = currentCation.charge / divisor;

            let explanation = `The correct formula is ${toSubscript(correctFormula)}<br>`;
            explanation += `<div class="explanation">`;
            
            if (userAnswer === '') {
                explanation += `You didn't enter an answer!<br><br>`;
            }
            
            // Check for specific mistakes
            let mistakeFound = false;
            
            // Check for coefficient error (e.g., 2KSO4 instead of K2SO4)
            if (/^\d/.test(userAnswer)) {
                explanation += `<strong>‚ùå Coefficient Error!</strong><br>`;
                explanation += `‚Ä¢ You wrote a number in FRONT of the formula (like 2KSO‚ÇÑ)<br>`;
                explanation += `‚Ä¢ This number is called a coefficient and means "2 separate molecules"<br>`;
                explanation += `‚Ä¢ You need a SUBSCRIPT instead (like K‚ÇÇSO‚ÇÑ) to show atoms bonded together<br>`;
                explanation += `‚Ä¢ Coefficient = separate molecules, Subscript = bonded atoms in ONE molecule<br><br>`;
                mistakeFound = true;
            }
            
            // Check for capitalization errors
            if (!mistakeFound && userAnswer.toLowerCase() === correctAnswer.toLowerCase() && userAnswer !== correctAnswer) {
                explanation += `<strong>‚ùå Capitalization Error!</strong><br>`;
                explanation += `‚Ä¢ Chemical symbols must use correct capitalization<br>`;
                explanation += `‚Ä¢ First letter is UPPERCASE, second letter (if any) is lowercase<br>`;
                explanation += `‚Ä¢ Example: Na (not na or NA), Cl (not cl or CL), Mg (not mg or MG)<br><br>`;
                mistakeFound = true;
            }
            
            // Check for bracket mistakes
            const userNoBrackets = userAnswer.replace(/[()]/g, '');
            const correctNoBrackets = correctAnswer.replace(/[()]/g, '');
            
            if (!mistakeFound && userNoBrackets === correctNoBrackets && userAnswer !== correctAnswer) {
                if (correctAnswer.includes('(') && !userAnswer.includes('(')) {
                    explanation += `<strong>‚ùå Missing Brackets!</strong><br>`;
                    explanation += `‚Ä¢ Polyatomic ions need brackets when subscript > 1<br>`;
                    explanation += `‚Ä¢ "${isPolyatomic(currentAnion.symbol) ? currentAnion.symbol : currentCation.symbol}" is a polyatomic ion (multiple elements)<br>`;
                    explanation += `‚Ä¢ When you need more than one, use brackets: (${isPolyatomic(currentAnion.symbol) ? currentAnion.symbol : currentCation.symbol})${toSubscript((anionCount > 1 ? anionCount : cationCount).toString())}<br><br>`;
                    mistakeFound = true;
                } else if (!correctAnswer.includes('(') && userAnswer.includes('(')) {
                    explanation += `<strong>‚ùå Unnecessary Brackets!</strong><br>`;
                    explanation += `‚Ä¢ Only polyatomic ions (multiple elements) need brackets<br>`;
                    explanation += `‚Ä¢ Single element ions like Cl, O, Fe don't need brackets<br>`;
                    explanation += `‚Ä¢ Example: FeCl‚ÇÇ (not Fe(Cl)‚ÇÇ) because Cl is just one element<br><br>`;
                    mistakeFound = true;
                }
            }
            
            // Check for wrong subscripts
            if (!mistakeFound && userAnswer.replace(/\d/g, '') === correctAnswer.replace(/\d/g, '')) {
                explanation += `<strong>‚ùå Wrong Subscripts!</strong><br>`;
                explanation += `‚Ä¢ The numbers (subscripts) are incorrect<br>`;
                explanation += `‚Ä¢ You need to balance the charges correctly<br><br>`;
                mistakeFound = true;
            }
            
            if (!mistakeFound && userAnswer !== '') {
                explanation += `<strong>You wrote:</strong> ${toSubscript(userAnswer)}<br><br>`;
            }
            
            // Always show the charge balancing explanation
            explanation += `<strong>Charge Balancing:</strong><br>`;
            explanation += `‚Ä¢ ${currentCation.name} ‚Üí ${currentCation.symbol}<span class="superscript">${currentCation.charge}+</span><br>`;
            explanation += `‚Ä¢ ${currentAnion.name} ‚Üí ${currentAnion.symbol}<span class="superscript">${currentAnion.charge}‚àí</span><br>`;
            explanation += `‚Ä¢ To balance charges: need ${cationCount} ${currentCation.symbol} and ${anionCount} ${currentAnion.symbol}<br>`;
            explanation += `‚Ä¢ Total positive: ${cationCount} √ó ${currentCation.charge}+ = ${cationCount * currentCation.charge}+<br>`;
            explanation += `‚Ä¢ Total negative: ${anionCount} √ó ${currentAnion.charge}‚àí = ${anionCount * currentAnion.charge}‚àí<br>`;
            
            if (isPolyatomic(currentAnion.symbol) && anionCount > 1) {
                explanation += `‚Ä¢ Polyatomic ion "${currentAnion.symbol}" needs brackets: (${currentAnion.symbol})${toSubscript(anionCount.toString())}`;
            } else if (isPolyatomic(currentCation.symbol) && cationCount > 1) {
                explanation += `‚Ä¢ Polyatomic ion "${currentCation.symbol}" needs brackets: (${currentCation.symbol})${toSubscript(cationCount.toString())}`;
            }
            
            explanation += `</div>`;
            return explanation;
        }

        function showGameOver() {
            const container = document.querySelector('.game-container');
            container.innerHTML = `
                <h1 style="color: #2ecc71;">üéâ Congratulations!</h1>
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 4em; margin: 20px 0;">üèÜ</div>
                    <h2 style="color: #333; margin-bottom: 20px;">You achieved a 5-question streak!</h2>
                    <div class="stats" style="margin: 30px 0;">
                        <div class="stat">
                            <div class="stat-label">Final Score</div>
                            <div class="stat-value" style="color: #2ecc71;">${score}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Total Attempted</div>
                            <div class="stat-value" style="color: #2ecc71;">${total}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Accuracy</div>
                            <div class="stat-value" style="color: #2ecc71;">${Math.round((score/total)*100)}%</div>
                        </div>
                    </div>
                    <p style="font-size: 1.2em; color: #666; margin: 20px 0;">Excellent work on mastering chemical formulas!</p>
                    <button class="new-game-btn" onclick="location.reload()">Play Again</button>
                </div>
            `;
        }

        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('streak').textContent = streak;
            document.getElementById('total').textContent = total;
        }

        document.getElementById('submitBtn').addEventListener('click', checkAnswer);
        
        document.getElementById('skipBtn').addEventListener('click', () => {
            clearInterval(timerInterval);
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback incorrect';
            feedback.innerHTML = `Skipped. The correct formula is ${toSubscript(correctFormula)}`;
            total++;
            streak = 0;
            playSound('incorrect');
            updateStats();
            setTimeout(() => {
                newQuestion();
            }, 2000);
        });

        document.getElementById('formulaInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkAnswer();
        });

        // Sound toggle
        document.getElementById('soundToggle').addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
        });

        function startGame(level) {
            currentLevel = level;
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('gameContainer').classList.add('active');
            document.getElementById('levelInfo').textContent = level === 1 ? 'Level 1: With Charges' : 'Level 2: Names Only';
            resetGame();
        }

        function backToMenu() {
            clearInterval(timerInterval);
            document.getElementById('gameContainer').classList.remove('active');
            document.getElementById('introScreen').style.display = 'block';
            resetGame();
        }

        function resetGame() {
            score = 0;
            streak = 0;
            total = 0;
            wrongAnswers = [];
            updateStats();
            if (document.getElementById('gameContainer').classList.contains('active')) {
                newQuestion();
            }
        }
    </script>
</body>
</html>
